"use strict";!function(e){window.popUserAccount={sessions:{},initDocument:function(e){var s=this,n=e.domain;s.initialLogin(n)},initDomain:function(e){var s=this,n=e.domain;s.sessions[n]={initialuserdata:!0,loggedin:!1,id:null,name:"",avatar:"",url:"",roles:[],userattributes:[]}},documentInitialized:function(e){var s=this;e.domain;s.checkpointInvalidateBlocks(),s.fetchAllDomainsLoggedInUserData()},pageSectionInitialized:function(e){var s=this;e.pageSection.on("fetched",function(e,n,i,t){s.feedbackLoginOut(t,!1)})},blockInitialized:function(e){var s=this;e.pageSection;e.block.on("fetched",function(e,n,i,t){s.feedbackLoginOut(t,!1)})},loadAvatar:function(e){var s=this,n=e.domain;e.targets.attr("src",s.sessions[n].avatar)},initialLogin:function(e){var s=this,n=s.feedbackLoginOut(e,!0);s.sessions[e].initialuserdata=!n},fetchAllDomainsLoggedInUserData:function(s){var n=this;e.each(M.USERLOGGEDIN_DATA_PAGEURLS,function(e,i){var t=getDomain(i);n.sessions[t].initialuserdata&&n.fetchLoggedInUserData(i,s)})},fetchLoggedInUserData:function(e,s){(s=s||{})["loadingmsg-target"]=M.USERLOGGEDIN_LOADINGMSG_TARGET,s.silentDocument=!0,popManager.fetch(e,s)},isLoggedInAnyDomain:function(){var s=this,n=!1;return e.each(s.sessions,function(e,s){if(s.loggedin)return n=!0,-1}),n},isLoggedIn:function(e){return this.sessions[e].loggedin},updateUserInfo:function(s,n,i,t,o,a,r){var d=this,u={},c=getDomainId(s);d.sessions[s].name!=i&&(d.sessions[s].name=i,e(".pop-user-name."+c).text(i),u.name=i),d.sessions[s].id==n&&d.sessions[s].avatar==t||(d.sessions[s].id=n,d.sessions[s].avatar=t,e(".pop-user-avatar."+c).attr("src",t),u.avatar=t),d.sessions[s].url!=o&&(d.sessions[s].url=o,e(".pop-user-url."+c).attr("href",o),u.url=o),0===e(d.sessions[s].roles).not(a).length&&0===e(a).not(d.sessions[s].roles).length||(d.sessions[s].roles=a,e.each(M.ROLES,function(s,n){e(document.body).removeClass(n+"-"+c)}),e.each(d.sessions[s].roles,function(s,n){e(document.body).addClass(n+"-"+c)}),u.roles=a),0===e(d.sessions[s].userattributes).not(r).length&&0===e(r).not(d.sessions[s].userattributes).length||(d.sessions[s].userattributes=r,e.each(M.USERATTRIBUTES,function(s,n){e(document.body).removeClass(n+"-"+c)}),e.each(d.sessions[s].userattributes,function(s,n){e(document.body).addClass(n+"-"+c)}),u.userattributes=r),e.isEmptyObject(u)||(u.id=n,e(document).triggerHandler("user:updated",[u,s]),e(document).triggerHandler("user:updated:"+s,[u]))},loginout:function(s,n,i,t,o,a,r,d,u){var c=this;if(c.updateUserInfo(n,t,o,a,r,d,u),c.sessions[n].loggedin!=i){c.sessions[n].loggedin=i;var g=[];n==M.HOME_DOMAIN&&g.push("loggedin-localdomain");var o,l=e(document.body),f=getDomainId(n);c.sessions[n].loggedin?(g.push("loggedin-anydomain"),l.data("loggedinuser-id-"+f,t).addClass("loggedin-"+f+" user-"+t+"-"+f),e.each(g,function(e,s){l.addClass(s)}),o="user:loggedin"):(c.isLoggedInAnyDomain()||g.push("loggedin-anydomain"),l.removeClass("loggedin-"+f).removeClass("user-"+l.data("loggedinuser-id-"+f)+"-"+f).data("loggedinuser-id-"+f,""),e.each(g,function(e,s){l.removeClass(s)}),o="user:loggedout"),"initialfeedback"!=s&&c.closeCheckpointMessages(n),e(document).triggerHandler(o,[s,n]),e(document).triggerHandler(o+":"+n,[s]),e(document).triggerHandler("user:loggedinout",[s,n]),e(document).triggerHandler("user:loggedinout:"+n,[s])}},feedbackLoginOut:function(e,s){var n=this,i=popManager.getTopLevelFeedback(e)[M.DATALOAD_USER];if(void 0!==i){var t,o,a,r,d,u,c;t=i[M.DATALOAD_USER_LOGGEDIN],o=i[M.DATALOAD_USER_ID],a=i[M.DATALOAD_USER_NAME],r=i[M.DATALOAD_USER_AVATAR],d=i[M.DATALOAD_USER_URL],u=i[M.DATALOAD_USER_ROLES],c=i[M.DATALOAD_USER_ATTRIBUTES];var g="feedback";return s?g="initialfeedback":n.sessions[e].initialuserdata&&(g="initialuserdata",n.sessions[e].initialuserdata=!1),n.loginout(g,e,t,o,a,r,d,u,c),!0}return!1},checkpointInvalidateBlocks:function(){var s=this;e(document).on("user:loggedin",function(e,n,i){"initialfeedback"!=n&&"initialuserdata"!=n&&s.closeCheckpointMessages(i)})},closeCheckpointMessages:function(e){jQuery(document).ready(function(s){s(".alert.in.pop-messagefeedback.checkpoint."+getDomainId(e)).removeClass("fade").alert("close")})},getLoggedInUserId:function(e){var s=this;return!(!s.sessions[e]||!s.sessions[e].loggedin)&&s.sessions[e].id}}}(jQuery),popJSLibraryManager.register(popUserAccount,["initDocument","initDomain","documentInitialized","pageSectionInitialized","blockInitialized","loadAvatar"]);